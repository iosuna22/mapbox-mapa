<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Edificio Kuna - Experiencia Interactiva</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.12.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.12.0/mapbox-gl.js"></script>
  <style>
    body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    
    /* Panel de control */
    #controls {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.9);
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
      z-index: 10;
    }
    #controls button {
      display: block;
      margin: 8px 0;
      padding: 8px 12px;
      background: #4264fb;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.2s;
    }
    #controls button:hover {
      background: #2a52ff;
    }
    
    /* Loader */
    #loader {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.9);
      padding: 25px;
      border-radius: 15px;
      text-align: center;
      z-index: 100;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
    }
    .spinner {
      border: 5px solid rgba(0, 0, 0, 0.1);
      border-top: 5px solid #4264fb;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Popup estilizado */
    .mapboxgl-popup-content {
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
    }
  </style>
</head>
<body>
  <div id="map"></div>
  
  <div id="controls">
    <button id="rotate-btn">üîÑ Rotar Vista</button>
    <button id="pulse-btn">üíì Latido Edificio</button>
    <button id="light-btn">üåô Modo Nocturno</button>
    <button id="reset-btn">üè† Vista Inicial</button>
  </div>
  
  <div id="loader">
    <div class="spinner"></div>
    <p>Cargando experiencia 3D...</p>
  </div>

  <script>
    // Configuraci√≥n inicial
    mapboxgl.accessToken = 'pk.eyJ1IjoiaW9zdW5hYSIsImEiOiJjbWNjeGdvZGwwZTJ3Mmpxc3RwcmhhODI3In0.k4Q1fwjfujblZ11w5aGoCQ';
    
    const modelCoordinates = [-2.9231806364031483, 43.25397648476814];
    const viewKunaCoordinates = [-2.9232, 43.2541];
    const initialView = {
      center: [-2.92, 43.25],
      zoom: 13,
      pitch: 30,
      bearing: 0
    };
    
    // Inicializar mapa
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/standard',
      center: initialView.center,
      zoom: initialView.zoom,
      pitch: initialView.pitch,
      bearing: initialView.bearing,
      minZoom: 12,
      maxZoom: 22
    });
    
    // Variables de estado
    let isRotating = false;
    let isPulsing = false;
    let currentLight = 'day';
    let animationFrameId;
    
    // Controles
    const rotateBtn = document.getElementById('rotate-btn');
    const pulseBtn = document.getElementById('pulse-btn');
    const lightBtn = document.getElementById('light-btn');
    const resetBtn = document.getElementById('reset-btn');
    
    // ======================
    // FUNCIONES PRINCIPALES
    // ======================
    
    // 1. Animaci√≥n de vuelo inicial
    function initFlyTo() {
      map.flyTo({
        center: viewKunaCoordinates,
        zoom: 17,
        pitch: 45,
        bearing: -20,
        duration: 4000,
        curve: 1.2
      });
      
      setTimeout(() => {
        map.flyTo({
          center: viewKunaCoordinates,
          zoom: 18,
          pitch: 60,
          bearing: -300,
          duration: 3000,
          curve: 1.5
        });
        document.getElementById('loader').style.display = 'none';
      }, 4000);
    }
    
    // 2. Rotaci√≥n autom√°tica
    function toggleRotation() {
      isRotating = !isRotating;
      rotateBtn.textContent = isRotating ? '‚èπ Detener Rotaci√≥n' : 'üîÑ Rotar Vista';
      
      if (isRotating) {
        let bearing = map.getBearing();
        const rotate = () => {
          if (!isRotating) return;
          bearing += 0.5;
          map.easeTo({ bearing });
          animationFrameId = requestAnimationFrame(rotate);
        };
        rotate();
      } else {
        cancelAnimationFrame(animationFrameId);
      }
    }
    
    // 3. Efecto de pulso en el edificio
    function togglePulse() {
      isPulsing = !isPulsing;
      pulseBtn.textContent = isPulsing ? '‚èπ Detener Latido' : 'üíì Latido Edificio';
      
      let scale = 1;
      const pulse = () => {
        if (!isPulsing) return;
        scale = scale === 1 ? 1.03 : 1;
        map.setPaintProperty('modelo-kuna', 'model-scale', [scale, scale, scale]);
        setTimeout(pulse, 800);
      };
      
      if (isPulsing) pulse();
    }
    
    // 4. Cambio de iluminaci√≥n d√≠a/noche
    function toggleLight() {
      currentLight = currentLight === 'day' ? 'night' : 'day';
      lightBtn.textContent = currentLight === 'day' ? 'üåô Modo Nocturno' : '‚òÄÔ∏è Modo Diurno';
      map.setConfigProperty('basemap', 'lightPreset', currentLight);
    }
    
    // 5. Reset a vista inicial
    function resetView() {
      isRotating = false;
      rotateBtn.textContent = 'üîÑ Rotar Vista';
      cancelAnimationFrame(animationFrameId);
      
      map.flyTo({
        center: initialView.center,
        zoom: initialView.zoom,
        pitch: initialView.pitch,
        bearing: initialView.bearing,
        duration: 2000
      });
    }
    
    // ======================
    // CONFIGURACI√ìN DEL MAPA
    // ======================
    
    map.on('load', () => {
      // Ocultar etiquetas no deseadas
      map.setConfigProperty('basemap', 'showPlaceLabels', false);
      map.setConfigProperty('basemap', 'showRoadLabels', false);
      map.setConfigProperty('basemap', 'showPointOfInterestLabels', false);
      
      // A√±adir modelo 3D
      map.addSource('modelo-kuna', {
        type: 'geojson',
        data: {
          type: 'Feature',
          geometry: { type: 'Point', coordinates: modelCoordinates },
          properties: {
            'model-id': 'https://raw.githubusercontent.com/iosuna22/mapbox-mapa/main/edificio.glb'
          }
        }
      });
      
      map.addLayer({
        id: 'modelo-kuna',
        type: 'model',
        source: 'modelo-kuna',
        paint: {
          'model-rotation': [0, 0, 65],
          'model-scale': [1, 1, 1],
          'model-opacity': 0, // Inicia transparente
          'model-cast-shadows': true
        }
      });
      
      // Efecto fade-in para el modelo
      let opacity = 0;
      const fadeIn = () => {
        opacity += 0.02;
        map.setPaintProperty('modelo-kuna', 'model-opacity', opacity);
        if (opacity < 1) requestAnimationFrame(fadeIn);
      };
      setTimeout(fadeIn, 2000);
      
      // Iniciar animaci√≥n autom√°tica
      setTimeout(initFlyTo, 1000);
      
      // Event listeners para controles
      rotateBtn.addEventListener('click', toggleRotation);
      pulseBtn.addEventListener('click', togglePulse);
      lightBtn.addEventListener('click', toggleLight);
      resetBtn.addEventListener('click', resetView);
    });
    
    // Optimizaci√≥n: Detener animaciones al hacer zoom out
    map.on('zoom', () => {
      if (map.getZoom() < 16 && isRotating) {
        toggleRotation();
      }
    });
  </script>
</body>
</html>