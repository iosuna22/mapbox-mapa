<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Casa Cuna con Hover y PosiciÃ³n Real</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.12.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.12.0/mapbox-gl.js"></script>
  <style>
    body { margin: 0; padding: 0; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    .mapboxgl-popup {
      max-width: 250px;
      font-family: sans-serif;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
    mapboxgl.accessToken =
      "pk.eyJ1IjoiaW9zdW5hYSIsImEiOiJjbWNjeGdvZGwwZTJ3Mmpxc3RwcmhhODI3In0.k4Q1fwjfujblZ11w5aGoCQ";

    const modelCoordinates = [-2.92322, 43.25401];

    const map = new mapboxgl.Map({
      container: "map",
      style: "mapbox://styles/mapbox/standard",
      center: modelCoordinates,
      zoom: 17,
      pitch: 45,
      bearing: 0,
      minZoom: 5,
      maxZoom: 22
    });

    const popup = new mapboxgl.Popup({
      closeButton: false,
      closeOnClick: false
    });

    map.on("style.load", () => {
      map.setConfigProperty("basemap", "lightPreset", "day");

      // ðŸ”» ELIMINAR etiquetas visibles por ID
      const layers = map.getStyle().layers;
      layers.forEach(layer => {
        const id = layer.id;
        if (
          id.includes("label") ||
          id.includes("name") ||
          id.includes("poi") ||
          id.includes("road") ||
          id.includes("place") ||
          id.includes("transit") ||
          id.includes("admin") ||
          id.includes("building-number")
        ) {
          try {
            map.removeLayer(id);
          } catch (e) {}
        }
      });

      // ðŸ”» CLIP para eliminar edificio base
      map.addSource("clip-casa-cuna", {
        type: "geojson",
        data: {
          type: "FeatureCollection",
          features: [{
            type: "Feature",
            geometry: {
              type: "Polygon",
              coordinates: [[
                [-2.92326, 43.25413],
                [-2.92313, 43.25413],
                [-2.92313, 43.25401],
                [-2.92326, 43.25401],
                [-2.92326, 43.25413]
              ]]
            }
          }]
        }
      });

      map.addLayer({
        id: "clip-layer",
        type: "clip",
        source: "clip-casa-cuna",
        layout: {
          "clip-layer-types": ["model"],
          "clip-layer-scope": ["basemap"]
        }
      });

      // ðŸ”» Modelo 3D
      map.addSource("edificio-kuna", {
        type: "geojson",
        data: {
          type: "Feature",
          geometry: {
            type: "Point",
            coordinates: modelCoordinates
          },
          properties: {
            "model-id": "https://raw.githubusercontent.com/iosuna22/mapbox-mapa/main/edificio.glb"
          }
        }
      });

      map.addLayer({
        id: "modelo-kuna",
        type: "model",
        source: "edificio-kuna",
        slot: "middle",
        layout: {
          "model-id": ["get", "model-id"]
        },
        paint: {
          "model-opacity": 1,
          "model-rotation": [0, 0, 240],
          "model-scale": [1.0, 1.0, 1.0],
          "model-cast-shadows": false,
          "model-emissive-strength": 0
        }
      });

      // ðŸ”» Capa invisible encima del modelo para detectar hover
      map.addSource("hover-kuna", {
        type: "geojson",
        data: {
          type: "FeatureCollection",
          features: [{
            type: "Feature",
            geometry: {
              type: "Point",
              coordinates: modelCoordinates
            },
            properties: {
              tooltip: `
                <strong>Edificio Kuna</strong><br/>
                <a href="https://predashboard.novha.io:3000/d/feof29yx7pkowb/bbk-kuna?orgId=1&from=now-5m&to=now&timezone=browser"
                   target="_blank">Ver dashboard</a>
              `
            }
          }]
        }
      });

      map.addLayer({
        id: "hover-kuna-layer",
        type: "symbol",
        source: "hover-kuna",
        layout: {
          "icon-size": 0.0001,
          "icon-image": "marker-15" // cualquier icono vÃ¡lido, invisible por tamaÃ±o
        }
      });

      // ðŸ”» Hover: mostrar tooltip
      map.on("mousemove", (e) => {
        const features = map.queryRenderedFeatures(e.point, {
          layers: ["hover-kuna-layer"]
        });

        map.getCanvas().style.cursor = features.length ? "pointer" : "";

        if (features.length) {
          popup
            .setLngLat(features[0].geometry.coordinates)
            .setHTML(features[0].properties.tooltip)
            .addTo(map);
        } else {
          popup.remove();
        }
      });
    });
  </script>
</body>
</html>
