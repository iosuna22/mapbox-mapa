<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Casa Cuna - Marcador Alto</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.12.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.12.0/mapbox-gl.js"></script>
  <style>
    body { margin: 0; padding: 0; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    
    /* Leyenda */
    #legend {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(255,255,255,0.9);
      padding: 10px;
      font-family: sans-serif;
      font-size: 14px;
      border-radius: 5px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      z-index: 1;
    }
    #legend a {
      color: #0077ff;
      cursor: pointer;
      text-decoration: underline;
    }
    
    /* Marcador elevado (150px sobre superficie) */
    .high-altitude-marker {
      background-image: url('https://raw.githubusercontent.com/iosuna22/mapbox-mapa/main/EdificioKuna.jpg');
      background-size: cover;
      width: 70px;
      height: 70px;
      border-radius: 50%;
      border: 3px solid white;
      box-shadow: 0 0 25px rgba(0,0,0,0.6);
      transform: translateY(-150px); /* Elevación extrema */
      transition: all 0.3s;
      z-index: 10;
    }
    .high-altitude-marker:hover {
      transform: translateY(-155px) scale(1.1);
      box-shadow: 0 0 30px rgba(0,0,0,0.8);
    }
    
    /* Loader */
    #loader {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255,255,255,0.9);
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      z-index: 100;
    }
    .spinner {
      border: 5px solid rgba(0,0,0,0.1);
      border-top: 5px solid #4264fb;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Popup estilizado */
    .mapboxgl-popup-content {
      border-radius: 8px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
  <div id="map"></div>
  
  <div id="legend">
    <strong>Leyenda:</strong><br/>
    <a id="goToModel" role="button" aria-label="Centrar mapa">Edificio Kuna</a>
  </div>
  
  <div id="loader">
    <div class="spinner"></div>
    <p>Cargando vista 3D...</p>
  </div>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiaW9zdW5hYSIsImEiOiJjbWNjeGdvZGwwZTJ3Mmpxc3RwcmhhODI3In0.k4Q1fwjfujblZ11w5aGoCQ';
    
    // Coordenadas del marcador (longitud, latitud)
    const markerLngLat = [-2.9230369118412556, 43.254037226606236];
    const markerHeight = 200; // Altura en metros sobre el suelo (eje Z)
    
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/standard',
      center: [-2.9232, 43.2541],
      zoom: 13,
      pitch: 65,  // Inclinación pronunciada
      bearing: 0,
      minZoom: 12,
      maxZoom: 22
    });

    // Popup
    const popup = new mapboxgl.Popup({ 
      closeButton: false, 
      offset: [0, -40] 
    });

    // Precargar imagen del marcador
    const preloadImage = () => {
      return new Promise((resolve) => {
        const img = new Image();
        img.src = 'https://raw.githubusercontent.com/iosuna22/mapbox-mapa/main/EdificioKuna.jpg';
        img.onload = () => resolve();
      });
    };

    // Inicializar mapa
    Promise.all([preloadImage()]).then(() => {
      map.on('load', () => {
        // Ocultar loader
        document.getElementById('loader').style.display = 'none';
        
        // Desactivar etiquetas
        const labels = [
          'showPlaceLabels', 
          'showRoadLabels', 
          'showPointOfInterestLabels', 
          'showTransitLabels'
        ];
        labels.forEach(label => {
          map.setConfigProperty('basemap', label, false);
        });

        // Añadir marcador elevado
        const markerEl = document.createElement('div');
        markerEl.className = 'high-altitude-marker';
        
        new mapboxgl.Marker({
          element: markerEl,
          anchor: 'bottom'
        })
        .setLngLat(markerLngLat)
        .addTo(map);

        // Fuente GeoJSON 3D para el área interactiva
        map.addSource('3d-hover', {
          type: 'geojson',
          data: {
            type: 'Feature',
            geometry: {
              type: 'Point',
              coordinates: [...markerLngLat, markerHeight] // [lng, lat, z]
            },
            properties: {
              tooltip: `
                <strong>Edificio Kuna</strong><br/>
                <a href="https://predashboard.novha.io:3000/d/feof29yx7pkowb/bbk-kuna"
                   target="_blank">Ver dashboard</a>`
            }
          }
        });

        // Capa invisible para interacción
        map.addLayer({
          id: '3d-hover-layer',
          type: 'circle',
          source: '3d-hover',
          paint: {
            'circle-radius': 35,
            'circle-opacity': 0
          }
        });

        // Eventos de interacción
        map.on('mousemove', '3d-hover-layer', (e) => {
          map.getCanvas().style.cursor = 'pointer';
          popup.setLngLat(markerLngLat)
               .setHTML(e.features[0].properties.tooltip)
               .addTo(map);
        });

        map.on('mouseleave', '3d-hover-layer', () => {
          map.getCanvas().style.cursor = '';
          popup.remove();
        });

        // Botón de la leyenda
        document.getElementById('goToModel').addEventListener('click', () => {
          map.flyTo({
            center: markerLngLat,
            zoom: 18,
            pitch: 75,  // Vista más aérea
            bearing: -30,
            speed: 0.5,
            curve: 2.0,
            essential: true
          });
        });

        // Vuelo inicial automático
        map.flyTo({
          center: markerLngLat,
          zoom: 17,
          pitch: 70,
          bearing: -20,
          duration: 4000,
          curve: 2.0
        });
      });
    });
  </script>
</body>
</html>